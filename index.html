import React, { useState, useEffect, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, onAuthStateChanged, signInAnonymously, signInWithCustomToken } from 'firebase/auth';
import { getFirestore, collection, doc, setDoc, onSnapshot, query, orderBy } from 'firebase/firestore';
import { 
  Utensils, Calculator, Calendar, Plus, Trash2, 
  TrendingDown, TrendingUp, Scale, Flame, Activity,
  ChevronLeft, ChevronRight, Heart
} from 'lucide-react';
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer } from 'recharts';

// --- Firebase é…ç½® ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'pastel-retro-tracker';

const App = () => {
  const [user, setUser] = useState(null);
  const [profile, setProfile] = useState({
    gender: 'female',
    age: 25,
    weight: 55,
    height: 160,
    activity: 1.375
  });
  const [history, setHistory] = useState({});
  const [weightLogs, setWeightLogs] = useState([]);
  const [newItem, setNewItem] = useState({ name: '', calories: '' });
  const [currentDate, setCurrentDate] = useState(new Date().toISOString().split('T')[0]);
  const [viewDate, setViewDate] = useState(new Date());

  // --- åˆå§‹åŒ– Auth ---
  useEffect(() => {
    const initAuth = async () => {
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        await signInWithCustomToken(auth, __initial_auth_token);
      } else {
        await signInAnonymously(auth);
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, setUser);
    return () => unsubscribe();
  }, []);

  // --- ç›£è½ Firestore æ•¸æ“š ---
  useEffect(() => {
    if (!user) return;

    const profileDoc = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'profile');
    const unsubProfile = onSnapshot(profileDoc, (docSnap) => {
      if (docSnap.exists()) setProfile(docSnap.data());
    });

    const historyCol = collection(db, 'artifacts', appId, 'users', user.uid, 'history');
    const unsubHistory = onSnapshot(historyCol, (snapshot) => {
      const data = {};
      snapshot.forEach(doc => { data[doc.id] = doc.data(); });
      setHistory(data);
    });

    const weightsCol = collection(db, 'artifacts', appId, 'users', user.uid, 'weights');
    const unsubWeights = onSnapshot(weightsCol, (snapshot) => {
      const logs = [];
      snapshot.forEach(doc => { logs.push({ date: doc.id, weight: doc.data().weight }); });
      setWeightLogs(logs.sort((a, b) => new Date(a.date) - new Date(b.date)));
    });

    return () => { unsubProfile(); unsubHistory(); unsubWeights(); };
  }, [user]);

  // --- è¨ˆç®— TDEE èˆ‡ èµ¤å­— ---
  const bmr = useMemo(() => {
    const { gender, age, weight, height } = profile;
    return gender === 'male' 
      ? 10 * weight + 6.25 * height - 5 * age + 5 
      : 10 * weight + 6.25 * height - 5 * age - 161;
  }, [profile]);

  const tdee = Math.round(bmr * profile.activity);
  const deficitTarget = tdee - 500; 

  const dailyData = history[currentDate] || { items: [], total: 0 };
  const currentCals = dailyData.total || 0;
  const remainingDeficit = deficitTarget - currentCals;

  // --- è™•ç†å‡½å¼ ---
  const updateProfile = async (field, value) => {
    if (!user) return;
    const newProfile = { ...profile, [field]: value };
    setProfile(newProfile);
    await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'profile'), newProfile);
  };

  const addFood = async () => {
    if (!user || !newItem.name || !newItem.calories) return;
    const updatedItems = [...(dailyData.items || []), { ...newItem, id: Date.now() }];
    const newTotal = updatedItems.reduce((sum, item) => sum + Number(item.calories), 0);
    await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'history', currentDate), {
      items: updatedItems,
      total: newTotal
    });
    setNewItem({ name: '', calories: '' });
  };

  const removeFood = async (id) => {
    if (!user) return;
    const updatedItems = dailyData.items.filter(item => item.id !== id);
    const newTotal = updatedItems.reduce((sum, item) => sum + Number(item.calories), 0);
    await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'history', currentDate), {
      items: updatedItems,
      total: newTotal
    });
  };

  const logWeight = async () => {
    if (!user) return;
    await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'weights', currentDate), {
      weight: profile.weight,
      timestamp: new Date()
    });
  };

  const getCalendarDays = () => {
    const year = viewDate.getFullYear();
    const month = viewDate.getMonth();
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    return [...Array(firstDay).fill(null), ...Array.from({length: daysInMonth}, (_, i) => new Date(year, month, i + 1))];
  };

  return (
    <div className="min-h-screen bg-[#FFFDF3] p-4 md:p-8 font-sans text-[#5F4B8B]">
      {/* Header */}
      <header className="max-w-6xl mx-auto mb-10 text-center relative">
        <div className="absolute top-0 left-1/2 -translate-x-1/2 -translate-y-8 w-80 h-32 bg-[#D1C4E9] rounded-full blur-3xl opacity-30 -z-10"></div>
        <h1 className="text-5xl md:text-7xl font-black text-[#B197FC] italic tracking-tighter uppercase drop-shadow-[4px_4px_0px_#E5DBFF] mb-2">
          Sweet Pastel Health
        </h1>
        <div className="inline-block bg-[#FFEB3B] border-2 border-[#5F4B8B] text-[#5F4B8B] px-8 py-1.5 rounded-full font-black text-xs tracking-[0.3em] uppercase shadow-[4px_4px_0px_#5F4B8B]">
          Daily Body Log â€¢ ç¾å¼æŸ”å’Œå¾©å¤
        </div>
      </header>

      <div className="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-8">
        
        {/* å·¦å´é¢æ¿ (4/12) - å€‹äººè³‡æ–™èˆ‡èµ¤å­— */}
        <div className="lg:col-span-4 space-y-8">
          <section className="bg-white border-[5px] border-[#5F4B8B] rounded-[50px] p-8 shadow-[10px_10px_0px_#D1C4E9] relative overflow-hidden">
             <div className="absolute -top-4 -right-4 text-[#E5DBFF] opacity-40 rotate-12"><Heart size={120} fill="currentColor"/></div>
             
             <h2 className="text-2xl font-black italic uppercase mb-6 flex items-center gap-2 relative z-10">
               <Calculator className="text-[#B197FC]" /> èº«æåƒæ•¸è¨­å®š
             </h2>
             
             <div className="space-y-4 relative z-10">
               <div className="grid grid-cols-2 gap-4">
                 <div>
                   <label className="text-[10px] font-black uppercase mb-1 block opacity-50">GENDER</label>
                   <select className="w-full bg-[#F3F0FF] border-2 border-[#5F4B8B] rounded-2xl p-2.5 font-bold focus:ring-4 ring-[#FFEB3B]/30 outline-none" 
                     value={profile.gender} onChange={e => updateProfile('gender', e.target.value)}>
                     <option value="male">ç´³å£« MALE</option>
                     <option value="female">æ·‘å¥³ FEMALE</option>
                   </select>
                 </div>
                 <div>
                   <label className="text-[10px] font-black uppercase mb-1 block opacity-50">AGE</label>
                   <input type="number" className="w-full bg-[#F3F0FF] border-2 border-[#5F4B8B] rounded-2xl p-2.5 font-bold" 
                     value={profile.age} onChange={e => updateProfile('age', Number(e.target.value))} />
                 </div>
               </div>

               <div className="grid grid-cols-2 gap-4">
                 <div>
                   <label className="text-[10px] font-black uppercase mb-1 block opacity-50">HEIGHT (CM)</label>
                   <input type="number" className="w-full bg-[#F3F0FF] border-2 border-[#5F4B8B] rounded-2xl p-2.5 font-bold" 
                     value={profile.height} onChange={e => updateProfile('height', Number(e.target.value))} />
                 </div>
                 <div>
                   <label className="text-[10px] font-black uppercase mb-1 block opacity-50">WEIGHT (KG)</label>
                   <input type="number" className="w-full bg-[#F3F0FF] border-2 border-[#5F4B8B] rounded-2xl p-2.5 font-bold" 
                     value={profile.weight} onChange={e => updateProfile('weight', Number(e.target.value))} />
                 </div>
               </div>

               <button onClick={logWeight} className="w-full bg-[#B197FC] border-[3px] border-[#5F4B8B] text-white rounded-2xl py-3 font-black uppercase flex items-center justify-center gap-2 hover:bg-[#9775FA] transition-all shadow-[4px_4px_0px_#5F4B8B] active:translate-x-1 active:translate-y-1 active:shadow-none">
                 <Scale size={20}/> ç´€éŒ„ä»Šæ—¥é«”é‡ LOG WEIGHT
               </button>

               <div className="mt-8 pt-6 border-t-2 border-[#5F4B8B] border-dashed">
                 <div className="bg-[#FFEB3B] border-[3px] border-[#5F4B8B] rounded-[30px] p-6 shadow-inner text-center">
                   <div className="text-[10px] font-black uppercase text-[#5F4B8B] opacity-60 mb-1">æ¸›è„‚èµ¤å­—ç›®æ¨™ (TDEE-500)</div>
                   <div className="text-4xl font-black">{deficitTarget} <span className="text-sm">KC</span></div>
                 </div>
                 <div className="mt-4 flex justify-between items-center px-2">
                   <span className="text-xs font-black uppercase italic opacity-60">Your TDEE:</span>
                   <span className="text-sm font-black">{tdee} KCAL</span>
                 </div>
               </div>
             </div>
          </section>

          {/* ç†±é‡ç‹€æ…‹å¡ */}
          <section className="bg-[#B197FC] border-[5px] border-[#5F4B8B] rounded-[40px] p-8 shadow-[10px_10px_0px_#E5DBFF] text-white relative">
             <div className="absolute top-4 right-6 animate-pulse opacity-50"><Flame size={24}/></div>
             <h2 className="text-xl font-black uppercase italic mb-4">æ”å–ç‹€æ…‹</h2>
             <div className="flex justify-between items-end mb-3">
               <div className="text-5xl font-black">{currentCals}</div>
               <div className="text-right pb-1">
                 <div className="text-[10px] font-bold uppercase opacity-80">è·é›¢ç›®æ¨™</div>
                 <div className="text-xl font-black">{remainingDeficit > 0 ? `+${remainingDeficit}` : remainingDeficit}</div>
               </div>
             </div>
             <div className="h-6 bg-white/20 rounded-full border-2 border-white/50 overflow-hidden p-1">
                <div 
                  className="h-full bg-white rounded-full transition-all duration-1000"
                  style={{ width: `${Math.min((currentCals / deficitTarget) * 100, 100)}%` }}
                ></div>
             </div>
             <p className="mt-4 text-[10px] font-black text-center uppercase tracking-widest bg-black/10 py-1 rounded-full">
               {currentCals > tdee ? "âš ï¸ è¶…æ¨™è­¦å‘Š" : currentCals > deficitTarget ? "âœ¨ å®Œç¾èµ¤å­—å€" : "ğŸ­ å°šæœ‰é¡åº¦"}
             </p>
          </section>
        </div>

        {/* ä¸­é–“é¢æ¿ (4/12) - é£²é£Ÿæ¸…å–® */}
        <section className="lg:col-span-4 bg-white border-[5px] border-[#5F4B8B] rounded-[50px] p-8 shadow-[10px_10px_0px_#D1C4E9] flex flex-col h-full relative">
          <div className="absolute top-8 right-8 text-[#FFEB3B] opacity-20"><Utensils size={60}/></div>
          <div className="flex items-center justify-between mb-8">
            <h2 className="text-3xl font-black italic uppercase flex items-center gap-3">
              <span className="bg-[#B197FC] text-white p-2 rounded-xl"><Utensils size={24}/></span> MENU
            </h2>
            <div className="text-[10px] font-black uppercase opacity-40 text-right">
              {currentDate.replace(/-/g, '.')}
            </div>
          </div>

          <div className="space-y-4 mb-6">
            <input type="text" placeholder="é£Ÿç‰©åç¨±..." className="w-full bg-[#F3F0FF] border-2 border-[#5F4B8B] rounded-2xl p-3 font-bold text-sm outline-none ring-[#FFEB3B] focus:ring-4 placeholder-[#B197FC]/40" 
              value={newItem.name} onChange={e => setNewItem({...newItem, name: e.target.value})} />
            <div className="flex gap-2">
              <input type="number" placeholder="KCAL" className="flex-1 bg-[#F3F0FF] border-2 border-[#5F4B8B] rounded-2xl p-3 font-bold text-sm outline-none" 
                value={newItem.calories} onChange={e => setNewItem({...newItem, calories: e.target.value})} />
              <button onClick={addFood} className="bg-[#FFEB3B] border-[3px] border-[#5F4B8B] rounded-2xl px-6 font-black hover:scale-105 active:scale-95 transition-all shadow-[4px_4px_0px_#5F4B8B]">
                <Plus strokeWidth={4} size={24}/>
              </button>
            </div>
          </div>

          <div className="flex-1 space-y-3 overflow-y-auto max-h-[500px] pr-2 custom-scrollbar">
            {dailyData.items?.length > 0 ? (
              dailyData.items.map(item => (
                <div key={item.id} className="bg-[#FAF9FF] border-2 border-[#5F4B8B] rounded-2xl p-4 flex justify-between items-center group transition-all hover:bg-[#E5DBFF]/30">
                  <div>
                    <div className="font-black text-[#5F4B8B] text-sm">{item.name}</div>
                    <div className="text-[10px] font-black text-[#B197FC] tracking-tighter">{item.calories} KCAL</div>
                  </div>
                  <button onClick={() => removeFood(item.id)} className="text-[#5F4B8B]/30 hover:text-[#B197FC] p-2">
                    <Trash2 size={16} />
                  </button>
                </div>
              ))
            ) : (
              <div className="h-40 flex flex-col items-center justify-center text-[#B197FC]/30">
                <div className="bg-[#F3F0FF] p-4 rounded-full mb-2"><Activity size={30} /></div>
                <span className="font-black uppercase text-[10px] tracking-widest">NO RECORDS YET</span>
              </div>
            )}
          </div>
        </section>

        {/* å³å´é¢æ¿ (4/12) - æ—¥æ›†èˆ‡è¶¨å‹¢ */}
        <section className="lg:col-span-4 bg-white border-[5px] border-[#5F4B8B] rounded-[50px] p-8 shadow-[10px_10px_0px_#D1C4E9] flex flex-col">
          <div className="flex items-center justify-between mb-8">
            <h2 className="text-2xl font-black italic uppercase flex items-center gap-2">
              <Calendar className="text-[#B197FC]" /> HISTORY
            </h2>
            <div className="flex items-center gap-2">
              <button onClick={() => setViewDate(new Date(viewDate.getFullYear(), viewDate.getMonth() - 1))} className="p-1 hover:text-[#B197FC] transition-colors"><ChevronLeft size={20}/></button>
              <span className="font-black text-xs uppercase tracking-tighter">{viewDate.toLocaleString('default', { month: 'short', year: 'numeric' })}</span>
              <button onClick={() => setViewDate(new Date(viewDate.getFullYear(), viewDate.getMonth() + 1))} className="p-1 hover:text-[#B197FC] transition-colors"><ChevronRight size={20}/></button>
            </div>
          </div>
          
          <div className="grid grid-cols-7 gap-1 mb-8">
            {['S', 'M', 'T', 'W', 'T', 'F', 'S'].map(d => (
              <div key={d} className="text-center text-[9px] font-black opacity-30 pb-2">{d}</div>
            ))}
            {getCalendarDays().map((date, i) => {
              if (!date) return <div key={i} className="aspect-square"></div>;
              const ds = date.toISOString().split('T')[0];
              const log = history[ds];
              const isSelected = ds === currentDate;
              const isToday = ds === new Date().toISOString().split('T')[0];
              
              return (
                <button key={ds} onClick={() => setCurrentDate(ds)}
                  className={`aspect-square rounded-xl border-2 border-transparent flex flex-col items-center justify-center transition-all relative
                    ${isSelected ? 'bg-[#5F4B8B] text-white border-[#5F4B8B]' : 'hover:bg-[#F3F0FF]'}
                    ${isToday && !isSelected ? 'border-[#B197FC]' : ''}`}>
                  <span className="text-[10px] font-black">{date.getDate()}</span>
                  {log && <div className={`w-1.5 h-1.5 rounded-full mt-1 ${log.total > deficitTarget ? 'bg-[#FFEB3B]' : 'bg-[#B197FC]'}`}></div>}
                </button>
              );
            })}
          </div>

          <div className="mt-auto pt-6 border-t-4 border-[#5F4B8B] border-dotted">
             <h3 className="text-sm font-black uppercase mb-4 flex items-center gap-2 italic">
               <TrendingUp size={16} className="text-[#B197FC]"/> WEIGHT TREND
             </h3>
             <div className="h-44 w-full -ml-4">
               <ResponsiveContainer width="100%" height="100%">
                 <LineChart data={weightLogs}>
                   <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#E5DBFF" />
                   <XAxis dataKey="date" hide />
                   <YAxis hide domain={['dataMin - 1', 'dataMax + 1']} />
                   <Tooltip 
                     contentStyle={{ borderRadius: '20px', border: '3px solid #5F4B8B', fontFamily: 'inherit', fontWeight: 'black', fontSize: '10px' }}
                     labelFormatter={(val) => `DATE: ${val}`}
                   />
                   <Line 
                    type="monotone" 
                    dataKey="weight" 
                    stroke="#B197FC" 
                    strokeWidth={5} 
                    dot={{ r: 4, strokeWidth: 2, fill: '#FFEB3B', stroke: '#5F4B8B' }} 
                    activeDot={{ r: 6, stroke: '#5F4B8B', strokeWidth: 3 }}
                   />
                 </LineChart>
               </ResponsiveContainer>
             </div>
          </div>
        </section>

      </div>

      {/* Footer */}
      <footer className="mt-16 mb-8 text-center">
        <div className="inline-flex items-center gap-6 px-10 py-3 bg-[#E5DBFF]/30 rounded-full">
          <div className="h-2 w-2 rounded-full bg-[#B197FC]"></div>
          <div className="text-[10px] font-black uppercase tracking-[0.4em] text-[#5F4B8B]">Stay Healthy & Pastel</div>
          <div className="h-2 w-2 rounded-full bg-[#FFEB3B]"></div>
        </div>
      </footer>

      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,400;0,700;0,900;1,400;1,700;1,900&display=swap');
        
        body {
          font-family: 'Montserrat', sans-serif;
          background-image: 
            radial-gradient(#D1C4E9 0.5px, transparent 0.5px);
          background-size: 30px 30px;
        }

        .custom-scrollbar::-webkit-scrollbar {
          width: 5px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
          background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
          background: #D1C4E9;
          border-radius: 10px;
        }

        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
          -webkit-appearance: none; 
          margin: 0; 
        }
      `}</style>
    </div>
  );
};

export default App;

