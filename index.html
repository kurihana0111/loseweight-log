<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sweet Pastel Health - 全功能復古追蹤器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,400;0,700;0,900;1,400;1,700;1,900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #FFFDF3;
            background-image: radial-gradient(#D1C4E9 0.5px, transparent 0.5px);
            background-size: 30px 30px;
            color: #5F4B8B;
        }
        .retro-shadow { box-shadow: 10px 10px 0px #D1C4E9; }
        .inner-shadow { box-shadow: inset 4px 4px 10px rgba(0,0,0,0.05); }
        .btn-active:active { transform: translate(4px, 4px); box-shadow: none; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #D1C4E9; border-radius: 10px; }
        
        @keyframes popIn {
            0% { transform: scale(0.8) translateY(20px); opacity: 0; }
            100% { transform: scale(1) translateY(0); opacity: 1; }
        }
        .ai-reward-box { animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">

    <!-- Header -->
    <header class="max-w-6xl mx-auto mb-10 text-center relative">
        <div class="absolute top-0 left-1/2 -translate-x-1/2 -translate-y-8 w-80 h-32 bg-[#D1C4E9] rounded-full blur-3xl opacity-30 -z-10"></div>
        <h1 class="text-5xl md:text-7xl font-black text-[#B197FC] italic tracking-tighter uppercase drop-shadow-[4px_4px_0px_#E5DBFF] mb-2">
            Sweet Pastel Health
        </h1>
        <div class="inline-block bg-[#FFEB3B] border-2 border-[#5F4B8B] text-[#5F4B8B] px-8 py-1.5 rounded-full font-black text-xs tracking-[0.3em] uppercase shadow-[4px_4px_0px_#5F4B8B]">
            AI Body Tracker • 復古柔和運動風
        </div>
    </header>

    <main class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-8">
        
        <!-- 左側：參數與 AI -->
        <div class="lg:col-span-4 space-y-8">
            <section class="bg-white border-[5px] border-[#5F4B8B] rounded-[50px] p-8 retro-shadow relative overflow-hidden">
                <i data-lucide="calculator" class="absolute -top-4 -right-4 text-[#E5DBFF] opacity-40 rotate-12 w-32 h-32"></i>
                <h2 class="text-2xl font-black italic uppercase mb-6 flex items-center gap-2 relative z-10">
                    身材參數
                </h2>
                <div class="space-y-4 relative z-10">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="flex flex-col">
                            <label class="text-[10px] font-black opacity-50 mb-1">GENDER</label>
                            <select id="gender" onchange="calculateTDEE()" class="bg-[#F3F0FF] border-2 border-[#5F4B8B] rounded-2xl p-2.5 font-bold outline-none">
                                <option value="female">FEMALE</option>
                                <option value="male">MALE</option>
                            </select>
                        </div>
                        <div class="flex flex-col">
                            <label class="text-[10px] font-black opacity-50 mb-1">AGE</label>
                            <input type="number" id="age" value="25" oninput="calculateTDEE()" class="bg-[#F3F0FF] border-2 border-[#5F4B8B] rounded-2xl p-2.5 font-bold outline-none">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="flex flex-col">
                            <label class="text-[10px] font-black opacity-50 mb-1">HEIGHT (CM)</label>
                            <input type="number" id="height" value="160" oninput="calculateTDEE()" class="bg-[#F3F0FF] border-2 border-[#5F4B8B] rounded-2xl p-2.5 font-bold outline-none">
                        </div>
                        <div class="flex flex-col">
                            <label class="text-[10px] font-black opacity-50 mb-1">WEIGHT (KG)</label>
                            <input type="number" id="weight" value="55" oninput="calculateTDEE()" class="bg-[#F3F0FF] border-2 border-[#5F4B8B] rounded-2xl p-2.5 font-bold outline-none">
                        </div>
                    </div>
                    <button id="log-btn" onclick="logWeight()" class="w-full bg-[#B197FC] border-[3px] border-[#5F4B8B] text-white rounded-2xl py-3 font-black uppercase flex items-center justify-center gap-2 hover:bg-[#9775FA] transition-all shadow-[4px_4px_0px_#5F4B8B] btn-active mt-2">
                        <i data-lucide="scale"></i> 紀錄體重 & AI 獎勵
                    </button>
                    <div id="ai-loading" class="hidden text-center text-xs font-black text-[#B197FC] animate-pulse">COACH IS THINKING...</div>
                </div>

                <div class="mt-8 pt-6 border-t-2 border-[#5F4B8B] border-dashed text-center">
                    <div class="bg-[#FFEB3B] border-[3px] border-[#5F4B8B] rounded-[30px] p-6 inner-shadow">
                        <div class="text-[10px] font-black uppercase opacity-60 mb-1">建議赤字目標 (TDEE-500)</div>
                        <div class="text-4xl font-black"><span id="deficit-val">0</span> <span class="text-sm">KC</span></div>
                    </div>
                </div>
            </section>

            <div id="ai-reward-container" class="hidden">
                <div class="ai-reward-box bg-[#FFEB3B] border-[5px] border-[#5F4B8B] rounded-[30px] p-6 retro-shadow relative">
                    <div class="absolute -top-3 -left-3 bg-[#B197FC] text-white p-2 rounded-lg rotate-[-10deg] border-2 border-[#5F4B8B] text-[10px] font-black">Coach's Note</div>
                    <p id="ai-message" class="text-sm font-black italic leading-relaxed text-[#5F4B8B]">"You're doing marvelous, darling!"</p>
                </div>
            </div>
        </div>

        <!-- 中間：飲食清單與進度 -->
        <div class="lg:col-span-4 space-y-8">
            <section class="bg-white border-[5px] border-[#5F4B8B] rounded-[50px] p-8 retro-shadow flex flex-col relative h-[500px]">
                <div class="flex items-center justify-between mb-8">
                    <h2 class="text-2xl font-black italic uppercase flex items-center gap-3">
                        <span class="bg-[#B197FC] text-white p-2 rounded-xl"><i data-lucide="utensils"></i></span> MENU
                    </h2>
                    <div id="selected-date-label" class="text-[10px] font-black uppercase opacity-40">2026.01.01</div>
                </div>
                <div class="space-y-4 mb-6">
                    <input type="text" id="food-name" placeholder="食物..." class="w-full bg-[#F3F0FF] border-2 border-[#5F4B8B] rounded-2xl p-3 font-bold text-sm outline-none">
                    <div class="flex gap-2">
                        <input type="number" id="food-cals" placeholder="KCAL" class="flex-1 bg-[#F3F0FF] border-2 border-[#5F4B8B] rounded-2xl p-3 font-bold text-sm outline-none">
                        <button onclick="addFood()" class="bg-[#FFEB3B] border-[3px] border-[#5F4B8B] rounded-2xl px-6 font-black hover:scale-105 btn-active shadow-[4px_4px_0px_#5F4B8B]">
                            <i data-lucide="plus"></i>
                        </button>
                    </div>
                </div>
                <div id="food-list" class="flex-1 space-y-3 overflow-y-auto pr-2 custom-scrollbar"></div>
            </section>

            <section class="bg-[#B197FC] border-[5px] border-[#5F4B8B] rounded-[40px] p-8 shadow-[10px_10px_0px_#E5DBFF] text-white relative">
                <h2 class="text-xl font-black uppercase italic mb-4">今日熱量狀態</h2>
                <div class="flex justify-between items-end mb-3">
                    <div id="current-cals" class="text-5xl font-black">0</div>
                    <div class="text-right">
                        <div class="text-[10px] font-bold uppercase opacity-80">距離目標</div>
                        <div id="remaining-val" class="text-xl font-black">+0</div>
                    </div>
                </div>
                <div class="h-6 bg-white/20 rounded-full border-2 border-white/50 overflow-hidden p-1">
                    <div id="progress-bar" class="h-full bg-white rounded-full transition-all duration-1000 w-0"></div>
                </div>
            </section>
        </div>

        <!-- 右側：日曆與趨勢 -->
        <div class="lg:col-span-4 space-y-8">
            <section class="bg-white border-[5px] border-[#5F4B8B] rounded-[50px] p-8 retro-shadow">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-black italic uppercase">CALENDAR</h2>
                    <div class="flex gap-2">
                        <button onclick="changeMonth(-1)" class="p-1 hover:text-[#B197FC]"><i data-lucide="chevron-left"></i></button>
                        <span id="calendar-month" class="text-xs font-black uppercase">JAN 2026</span>
                        <button onclick="changeMonth(1)" class="p-1 hover:text-[#B197FC]"><i data-lucide="chevron-right"></i></button>
                    </div>
                </div>
                <div class="grid grid-cols-7 gap-1 text-center text-[10px] font-black opacity-30 mb-2">
                    <div>S</div><div>M</div><div>T</div><div>W</div><div>T</div><div>F</div><div>S</div>
                </div>
                <div id="calendar-grid" class="grid grid-cols-7 gap-1"></div>
            </section>

            <section class="bg-white border-[5px] border-[#5F4B8B] rounded-[50px] p-8 retro-shadow flex flex-col h-[350px]">
                <h2 class="text-xl font-black italic uppercase mb-4 flex items-center gap-2">
                    <i data-lucide="trending-up" class="text-[#B197FC]"></i> TREND
                </h2>
                <div class="flex-1 relative">
                    <canvas id="weightChart"></canvas>
                </div>
                <p class="text-[9px] font-black text-center mt-4 opacity-50">每減少 2KG 將觸發星星獎勵 ⭐</p>
            </section>
        </div>

    </main>

    <script>
        lucide.createIcons();

        const apiKey = ""; 
        let weightChart;
        let currentViewDate = new Date();
        let selectedDate = new Date().toISOString().split('T')[0];
        
        let state = {
            profile: { gender: 'female', age: 25, height: 160, weight: 55 },
            history: {}, // { '2026-01-01': { foods: [], weight: 55 } }
            weightLogs: [] // [{date: '01/01', weight: 55}]
        };

        // --- AI 獎勵語 ---
        async function fetchAIReward(weightChange) {
            const systemPrompt = "你是一位1950年代美式復古風格的健身教練，語氣熱情、充滿活力，常用 'Darling', 'Champ'。請針對使用者體重變化給予一段 40 字內中文鼓勵語。";
            const userQuery = `體重紀錄：${weightChange > 0 ? '增加' + weightChange : '減少' + Math.abs(weightChange)} 公斤。`;

            let retries = 0;
            while (retries < 5) {
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: userQuery }] }],
                            systemInstruction: { parts: [{ text: systemPrompt }] }
                        })
                    });
                    const result = await response.json();
                    return result.candidates?.[0]?.content?.parts?.[0]?.text;
                } catch (error) {
                    retries++;
                    await new Promise(res => setTimeout(res, Math.pow(2, retries) * 1000));
                }
            }
            return "幹得好，親愛的！繼續保持這股活力！";
        }

        // --- 圖表與日曆 ---
        function initChart() {
            const ctx = document.getElementById('weightChart').getContext('2d');
            const starPlugin = {
                id: 'starPlugin',
                afterDatasetsDraw(chart) {
                    const { ctx, data } = chart;
                    chart.getDatasetMeta(0).data.forEach((point, index) => {
                        if (index === 0) return;
                        if (data.datasets[0].data[index-1] - data.datasets[0].data[index] >= 2) {
                            ctx.save();
                            ctx.font = '20px Arial';
                            ctx.fillText('⭐', point.x - 10, point.y - 15);
                            ctx.restore();
                        }
                    });
                }
            };

            weightChart = new Chart(ctx, {
                type: 'line',
                data: { labels: [], datasets: [{ data: [], borderColor: '#B197FC', borderWidth: 5, pointRadius: 6, pointBackgroundColor: '#5F4B8B', tension: 0.3, fill: false }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { grid: { color: '#E5DBFF' } }, x: { grid: { display: false } } } },
                plugins: [starPlugin]
            });
        }

        function renderCalendar() {
            const grid = document.getElementById('calendar-grid');
            const monthLabel = document.getElementById('calendar-month');
            grid.innerHTML = '';
            
            const year = currentViewDate.getFullYear();
            const month = currentViewDate.getMonth();
            monthLabel.innerText = new Intl.DateTimeFormat('en-US', { month: 'short', year: 'numeric' }).format(currentViewDate).toUpperCase();

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            for (let i = 0; i < firstDay; i++) {
                grid.innerHTML += '<div></div>';
            }

            for (let d = 1; d <= daysInMonth; d++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const isSelected = dateStr === selectedDate;
                const hasData = state.history[dateStr];
                
                grid.innerHTML += `
                    <button onclick="selectDate('${dateStr}')" class="aspect-square rounded-xl flex flex-col items-center justify-center transition-all ${isSelected ? 'bg-[#5F4B8B] text-white' : 'hover:bg-[#F3F0FF]'}">
                        <span class="text-[10px] font-bold">${d}</span>
                        ${hasData ? '<div class="w-1 h-1 bg-[#FFEB3B] rounded-full mt-0.5"></div>' : ''}
                    </button>
                `;
            }
        }

        function selectDate(date) {
            selectedDate = date;
            document.getElementById('selected-date-label').innerText = date.replace(/-/g, '.');
            renderCalendar();
            renderFoods();
            calculateTDEE();
        }

        function changeMonth(dir) {
            currentViewDate.setMonth(currentViewDate.getMonth() + dir);
            renderCalendar();
        }

        // --- 核心邏輯 ---
        function calculateTDEE() {
            const { gender, age, height, weight } = state.profile;
            const bmr = gender === 'male' 
                ? (10 * weight + 6.25 * height - 5 * age + 5)
                : (10 * weight + 6.25 * height - 5 * age - 161);
            
            const tdee = Math.round(bmr * 1.375);
            const deficit = tdee - 500;
            document.getElementById('deficit-val').innerText = deficit;

            const dayData = state.history[selectedDate] || { foods: [] };
            const consumed = dayData.foods.reduce((s, f) => s + f.calories, 0);
            document.getElementById('current-cals').innerText = consumed;
            document.getElementById('remaining-val').innerText = (deficit - consumed >= 0 ? '+' : '') + (deficit - consumed);
            document.getElementById('progress-bar').style.width = `${Math.min((consumed/deficit)*100, 100)}%`;
        }

        async function logWeight() {
            const w = parseFloat(document.getElementById('weight').value);
            const prevWeight = state.weightLogs.length > 0 ? state.weightLogs[state.weightLogs.length - 1].weight : w;
            const diff = (w - prevWeight).toFixed(1);

            state.profile.weight = w;
            state.weightLogs.push({ date: selectedDate.slice(5), weight: w });
            
            // 更新圖表
            weightChart.data.labels = state.weightLogs.map(l => l.date);
            weightChart.data.datasets[0].data = state.weightLogs.map(l => l.weight);
            weightChart.update();

            // AI 
            document.getElementById('log-btn').disabled = true;
            document.getElementById('ai-loading').classList.remove('hidden');
            const msg = await fetchAIReward(diff);
            document.getElementById('ai-message').innerText = msg;
            document.getElementById('ai-reward-container').classList.remove('hidden');
            document.getElementById('ai-loading').classList.add('hidden');
            document.getElementById('log-btn').disabled = false;

            if (!state.history[selectedDate]) state.history[selectedDate] = { foods: [] };
            state.history[selectedDate].weight = w;
            renderCalendar();
            calculateTDEE();
        }

        function addFood() {
            const name = document.getElementById('food-name').value;
            const cals = parseInt(document.getElementById('food-cals').value);
            if (!name || !cals) return;

            if (!state.history[selectedDate]) state.history[selectedDate] = { foods: [] };
            state.history[selectedDate].foods.push({ id: Date.now(), name, calories: cals });
            
            document.getElementById('food-name').value = '';
            document.getElementById('food-cals').value = '';
            renderFoods();
            renderCalendar();
            calculateTDEE();
        }

        function renderFoods() {
            const list = document.getElementById('food-list');
            const dayData = state.history[selectedDate] || { foods: [] };
            list.innerHTML = dayData.foods.map(f => `
                <div class="bg-[#FAF9FF] border-2 border-[#5F4B8B] rounded-2xl p-4 flex justify-between items-center group">
                    <div>
                        <div class="font-black text-[#5F4B8B] text-sm">${f.name}</div>
                        <div class="text-[10px] font-black text-[#B197FC]">${f.calories} KCAL</div>
                    </div>
                    <button onclick="removeFood(${f.id})" class="text-[#5F4B8B]/30 hover:text-[#B197FC] p-2"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function removeFood(id) {
            state.history[selectedDate].foods = state.history[selectedDate].foods.filter(f => f.id !== id);
            renderFoods();
            calculateTDEE();
        }

        window.onload = () => {
            initChart();
            renderCalendar();
            renderFoods();
            calculateTDEE();
        };
    </script>
</body>
</html>

