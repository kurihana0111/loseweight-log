<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sweet Pastel Health - GitHub Deploy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,400;0,700;0,900;1,400;1,700;1,900&display=swap" rel="stylesheet">
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GitHub 部署配置說明 ---
        // 如果是在 GitHub Pages 執行，請手動填入你的 Firebase 配置
        const manualConfig = {
            apiKey: "你的_API_KEY",
            authDomain: "你的_PROJECT_ID.firebaseapp.com",
            projectId: "你的_PROJECT_ID",
            storageBucket: "你的_PROJECT_ID.appspot.com",
            messagingSenderId: "你的_ID",
            appId: "你的_APP_ID"
        };

        // 優先嘗試讀取環境注入的配置，若無則使用手動填寫的配置
        let firebaseConfig;
        try {
            firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : manualConfig;
        } catch (e) {
            firebaseConfig = manualConfig;
        }

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'pastel-health-github';

        let currentUser = null;
        let weightChart = null;
        let currentViewDate = new Date();
        let selectedDate = new Date().toISOString().split('T')[0];
        
        window.state = {
            profile: { gender: 'female', age: 25, height: 160, weight: 55 },
            history: {},
            weightLogs: []
        };

        // 驗證流程
        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (err) {
                console.error("Auth Error:", err);
                // 如果失敗可能是配置錯誤，顯示提示給用戶
                document.getElementById('user-id-display').innerText = "連線失敗：請檢查 Firebase 配置";
            }
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('user-id-display').innerText = `USER ID: ${user.uid.substring(0, 8)}`;
                setupListeners();
            } else {
                initAuth();
            }
        });

        function setupListeners() {
            if (!currentUser) return;
            const profileRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'settings', 'profile');
            onSnapshot(profileRef, (docSnap) => {
                if (docSnap.exists()) {
                    window.state.profile = docSnap.data();
                    updateProfileUI();
                    window.calculateTDEE();
                }
            }, (err) => console.log("Profile Listen Error:", err));

            const historyRef = collection(db, 'artifacts', appId, 'users', currentUser.uid, 'daily_history');
            onSnapshot(historyRef, (snapshot) => {
                snapshot.forEach(doc => { window.state.history[doc.id] = doc.data(); });
                window.renderCalendar();
                window.renderFoods();
                window.calculateTDEE();
            }, (err) => console.log("History Listen Error:", err));

            const weightRef = collection(db, 'artifacts', appId, 'users', currentUser.uid, 'weights');
            onSnapshot(weightRef, (snapshot) => {
                const logs = [];
                snapshot.forEach(doc => { logs.push({ date: doc.id, weight: doc.data().weight, fullDate: doc.data().fullDate }); });
                window.state.weightLogs = logs.sort((a, b) => new Date(a.fullDate) - new Date(b.fullDate));
                updateChart();
            }, (err) => console.log("Weight Listen Error:", err));
        }

        // 綁定全域函數供 HTML 使用
        window.updateProfileInDB = async () => {
            if (!currentUser) return;
            const profile = {
                gender: document.getElementById('gender').value,
                age: parseInt(document.getElementById('age').value) || 0,
                height: parseFloat(document.getElementById('height').value) || 0,
                weight: parseFloat(document.getElementById('weight').value) || 0
            };
            await setDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'settings', 'profile'), profile);
        };

        window.addFood = async () => {
            if (!currentUser) return;
            const name = document.getElementById('food-name').value;
            const cals = parseInt(document.getElementById('food-cals').value);
            if (!name || isNaN(cals)) return;
            const currentDayData = window.state.history[selectedDate] || { foods: [] };
            const newFoods = [...currentDayData.foods, { id: Date.now(), name, calories: cals }];
            await setDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'daily_history', selectedDate), { foods: newFoods });
            document.getElementById('food-name').value = '';
            document.getElementById('food-cals').value = '';
        };

        window.removeFood = async (foodId) => {
            const currentDayData = window.state.history[selectedDate];
            const newFoods = currentDayData.foods.filter(f => f.id !== foodId);
            await setDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'daily_history', selectedDate), { foods: newFoods });
        };

        window.logWeight = async () => {
            if (!currentUser) return;
            const w = parseFloat(document.getElementById('weight').value);
            if (isNaN(w)) return;
            await setDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'weights', selectedDate), { weight: w, fullDate: selectedDate });
            await window.updateProfileInDB();
            handleAIReward(w);
        };

        window.selectDate = (date) => {
            selectedDate = date;
            document.getElementById('selected-date-label').innerText = date.replace(/-/g, '.');
            window.renderCalendar();
            window.renderFoods();
            window.calculateTDEE();
        };

        window.changeMonth = (dir) => {
            currentViewDate.setMonth(currentViewDate.getMonth() + dir);
            window.renderCalendar();
        };

        window.calculateTDEE = () => {
            const { gender, age, height, weight } = window.state.profile;
            const bmr = gender === 'male' ? (10 * weight + 6.25 * height - 5 * age + 5) : (10 * weight + 6.25 * height - 5 * age - 161);
            const tdee = Math.round(bmr * 1.375);
            const deficit = tdee - 500;
            const deficitEl = document.getElementById('deficit-val');
            if (deficitEl) deficitEl.innerText = isNaN(deficit) ? 0 : deficit;

            const dayData = window.state.history[selectedDate] || { foods: [] };
            const consumed = dayData.foods.reduce((s, f) => s + f.calories, 0);
            document.getElementById('current-cals').innerText = consumed;
            const remain = deficit - consumed;
            document.getElementById('remaining-val').innerText = (remain >= 0 ? '+' : '') + remain;
            document.getElementById('progress-bar').style.width = `${Math.min((consumed/deficit)*100, 100)}%`;
        };

        window.renderFoods = () => {
            const list = document.getElementById('food-list');
            const dayData = window.state.history[selectedDate] || { foods: [] };
            list.innerHTML = dayData.foods.length ? dayData.foods.map(f => `
                <div class="bg-[#FAF9FF] border-2 border-[#5F4B8B] rounded-2xl p-4 flex justify-between items-center">
                    <div><div class="font-black text-sm">${f.name}</div><div class="text-[10px] text-[#B197FC] font-bold">${f.calories} KCAL</div></div>
                    <button onclick="removeFood(${f.id})" class="text-[#5F4B8B]/30 hover:text-[#B197FC] p-2"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                </div>`).join('') : '<div class="text-center py-10 opacity-20 text-xs font-bold uppercase tracking-widest">無數據</div>';
            lucide.createIcons();
        };

        window.renderCalendar = () => {
            const grid = document.getElementById('calendar-grid');
            const monthLabel = document.getElementById('calendar-month');
            if (!grid) return;
            grid.innerHTML = '';
            const year = currentViewDate.getFullYear();
            const month = currentViewDate.getMonth();
            monthLabel.innerText = new Intl.DateTimeFormat('en-US', { month: 'short', year: 'numeric' }).format(currentViewDate).toUpperCase();
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            for (let i = 0; i < firstDay; i++) grid.innerHTML += '<div></div>';
            for (let d = 1; d <= daysInMonth; d++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const isSelected = dateStr === selectedDate;
                grid.innerHTML += `
                    <button onclick="window.selectDate('${dateStr}')" class="aspect-square rounded-xl flex flex-col items-center justify-center transition-all ${isSelected ? 'bg-[#5F4B8B] text-white shadow-lg' : 'hover:bg-[#F3F0FF]'}">
                        <span class="text-[10px] font-bold">${d}</span>
                        ${window.state.history[dateStr] ? '<div class="w-1 h-1 bg-[#FFEB3B] rounded-full mt-0.5"></div>' : ''}
                    </button>`;
            }
        };

        function updateChart() {
            if (!weightChart) return;
            weightChart.data.labels = window.state.weightLogs.map(l => l.date.slice(5).replace('-', '/'));
            weightChart.data.datasets[0].data = window.state.weightLogs.map(l => l.weight);
            weightChart.update();
        }

        function updateProfileUI() {
            document.getElementById('gender').value = window.state.profile.gender;
            document.getElementById('age').value = window.state.profile.age;
            document.getElementById('height').value = window.state.profile.height;
            document.getElementById('weight').value = window.state.profile.weight;
        }

        async function handleAIReward(currentWeight) {
            const logs = window.state.weightLogs;
            const prevWeight = logs.length > 1 ? logs[logs.length - 2].weight : currentWeight;
            const diff = (currentWeight - prevWeight).toFixed(1);
            document.getElementById('ai-loading').classList.remove('hidden');
            const apiKey = ""; // API Key 
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `體重紀錄：${diff > 0 ? '增加' + diff : '減少' + Math.abs(diff)} 公斤。` }] }],
                        systemInstruction: { parts: [{ text: "你是一位1950年代美式復古健身教練，語氣充滿活力熱情，40字內中文鼓勵。" }] }
                    })
                });
                const result = await response.json();
                document.getElementById('ai-message').innerText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                document.getElementById('ai-reward-container').classList.remove('hidden');
            } catch (e) {
                document.getElementById('ai-message').innerText = "你表現得棒極了，甜心！";
            } finally {
                document.getElementById('ai-loading').classList.add('hidden');
            }
        }

        // 初始化 Chart.js
        window.addEventListener('DOMContentLoaded', () => {
            const ctx = document.getElementById('weightChart').getContext('2d');
            const starPlugin = {
                id: 'starPlugin',
                afterDatasetsDraw(chart) {
                    const { ctx, data } = chart;
                    chart.getDatasetMeta(0).data.forEach((point, index) => {
                        if (index === 0) return;
                        if (data.datasets[0].data[index-1] - data.datasets[0].data[index] >= 2) {
                            ctx.save();
                            ctx.font = '20px Arial';
                            ctx.fillText('⭐', point.x - 10, point.y - 15);
                            ctx.restore();
                        }
                    });
                }
            };
            weightChart = new Chart(ctx, {
                type: 'line',
                data: { labels: [], datasets: [{ data: [], borderColor: '#B197FC', borderWidth: 5, pointRadius: 6, pointBackgroundColor: '#5F4B8B', tension: 0.3, fill: false }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { grid: { color: '#E5DBFF' } }, x: { grid: { display: false } } } },
                plugins: [starPlugin]
            });
            window.selectDate(selectedDate);
            lucide.createIcons();
        });
    </script>

    <style>
        body { font-family: 'Montserrat', sans-serif; background-color: #FFFDF3; background-image: radial-gradient(#D1C4E9 0.5px, transparent 0.5px); background-size: 30px 30px; color: #5F4B8B; margin: 0; padding: 0; }
        .retro-shadow { box-shadow: 8px 8px 0px #D1C4E9; }
        .btn-active:active { transform: translate(4px, 4px); box-shadow: none; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #D1C4E9; border-radius: 10px; }
        @keyframes popIn { 0% { transform: scale(0.9); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .ai-reward-box { animation: popIn 0.4s ease-out forwards; }
    </style>
</head>
<body class="p-4 md:p-8">

    <header class="max-w-6xl mx-auto mb-10 text-center">
        <h1 class="text-5xl md:text-7xl font-black text-[#B197FC] italic tracking-tighter uppercase drop-shadow-[4px_4px_0px_#E5DBFF] mb-2">Sweet Pastel Health</h1>
        <div class="flex flex-col items-center gap-2">
            <div class="bg-[#FFEB3B] border-2 border-[#5F4B8B] px-6 py-1 rounded-full font-black text-xs tracking-widest shadow-[4px_4px_0px_#5F4B8B]">GITHUB DEPLOY READY</div>
            <span id="user-id-display" class="text-[9px] font-bold opacity-40">Connecting to Firebase...</span>
        </div>
    </header>

    <main class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-6">
        <!-- 參數區 -->
        <div class="lg:col-span-4 space-y-6">
            <section class="bg-white border-[4px] border-[#5F4B8B] rounded-[40px] p-6 retro-shadow">
                <h2 class="text-xl font-black italic uppercase mb-4">身材參數</h2>
                <div class="space-y-3">
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="text-[9px] font-black opacity-40">GENDER</label>
                        <select id="gender" onchange="updateProfileInDB()" class="w-full bg-[#F3F0FF] border-2 border-[#5F4B8B] rounded-xl p-2 font-bold outline-none">
                            <option value="female">FEMALE</option><option value="male">MALE</option>
                        </select></div>
                        <div><label class="text-[9px] font-black opacity-40">AGE</label>
                        <input type="number" id="age" onchange="updateProfileInDB()" class="w-full bg-[#F3F0FF] border-2 border-[#5F4B8B] rounded-xl p-2 font-bold"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="text-[9px] font-black opacity-40">HEIGHT (CM)</label>
                        <input type="number" id="height" onchange="updateProfileInDB()" class="w-full bg-[#F3F0FF] border-2 border-[#5F4B8B] rounded-xl p-2 font-bold"></div>
                        <div><label class="text-[9px] font-black opacity-40">WEIGHT (KG)</label>
                        <input type="number" id="weight" onchange="updateProfileInDB()" class="w-full bg-[#F3F0FF] border-2 border-[#5F4B8B] rounded-xl p-2 font-bold"></div>
                    </div>
                    <button id="log-btn" onclick="logWeight()" class="w-full bg-[#B197FC] border-2 border-[#5F4B8B] text-white rounded-xl py-3 font-black uppercase shadow-[4px_4px_0px_#5F4B8B] btn-active">紀錄體重 & 同步</button>
                    <div id="ai-loading" class="hidden text-center text-[10px] font-black animate-pulse">COACH THINKING...</div>
                </div>
                <div class="mt-6 pt-4 border-t-2 border-dashed border-[#5F4B8B] text-center">
                    <div class="bg-[#FFEB3B] border-2 border-[#5F4B8B] rounded-2xl p-4">
                        <div class="text-[9px] font-black opacity-50 uppercase">建議赤字目標</div>
                        <div class="text-3xl font-black"><span id="deficit-val">0</span> <span class="text-xs">KC</span></div>
                    </div>
                </div>
            </section>
            <div id="ai-reward-container" class="hidden">
                <div class="ai-reward-box bg-[#FFEB3B] border-4 border-[#5F4B8B] rounded-2xl p-4 retro-shadow relative">
                    <p id="ai-message" class="text-xs font-black italic text-[#5F4B8B]"></p>
                </div>
            </div>
        </div>

        <!-- 飲食區 -->
        <div class="lg:col-span-4 space-y-6">
            <section class="bg-white border-[4px] border-[#5F4B8B] rounded-[40px] p-6 retro-shadow h-[450px] flex flex-col">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-black italic uppercase">MENU</h2>
                    <span id="selected-date-label" class="text-[9px] font-black opacity-40">DATE</span>
                </div>
                <div class="space-y-2 mb-4">
                    <input type="text" id="food-name" placeholder="食物..." class="w-full bg-[#F3F0FF] border-2 border-[#5F4B8B] rounded-xl p-2 font-bold text-sm">
                    <div class="flex gap-2">
                        <input type="number" id="food-cals" placeholder="KCAL" class="flex-1 bg-[#F3F0FF] border-2 border-[#5F4B8B] rounded-xl p-2 font-bold text-sm">
                        <button onclick="addFood()" class="bg-[#FFEB3B] border-2 border-[#5F4B8B] rounded-xl px-4 font-black btn-active shadow-[2px_2px_0px_#5F4B8B]">+</button>
                    </div>
                </div>
                <div id="food-list" class="flex-1 overflow-y-auto custom-scrollbar space-y-2"></div>
            </section>
            <section class="bg-[#B197FC] border-4 border-[#5F4B8B] rounded-[30px] p-6 text-white shadow-lg">
                <div class="flex justify-between items-end mb-2">
                    <div id="current-cals" class="text-4xl font-black">0</div>
                    <div id="remaining-val" class="text-lg font-black">+0</div>
                </div>
                <div class="h-4 bg-white/20 rounded-full overflow-hidden p-0.5 border border-white/30">
                    <div id="progress-bar" class="h-full bg-white rounded-full transition-all duration-500 w-0"></div>
                </div>
            </section>
        </div>

        <!-- 趨勢區 -->
        <div class="lg:col-span-4 space-y-6">
            <section class="bg-white border-[4px] border-[#5F4B8B] rounded-[40px] p-6 retro-shadow">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-black uppercase">CALENDAR</h2>
                    <div class="flex gap-2 items-center">
                        <button onclick="changeMonth(-1)" class="font-black">‹</button>
                        <span id="calendar-month" class="text-[10px] font-black">MONTH</span>
                        <button onclick="changeMonth(1)" class="font-black">›</button>
                    </div>
                </div>
                <div id="calendar-grid" class="grid grid-cols-7 gap-1"></div>
            </section>
            <section class="bg-white border-[4px] border-[#5F4B8B] rounded-[40px] p-6 retro-shadow h-[250px]">
                <canvas id="weightChart"></canvas>
            </section>
        </div>
    </main>

</body>
</html>

