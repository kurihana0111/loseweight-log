<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Retro Fit v4</title>
    <link href="https://fonts.googleapis.com/css2?family=Bungee&family=Fredoka:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --hot-pink: #FF499E;
            --soft-purple: #D4ADFC;
            --neon-purple: #7971EA;
            --sunny-yellow: #FFD93D;
            --bg-cream: #FFF9DE;
            --black: #222222;
        }

        body {
            background-color: var(--soft-purple);
            font-family: 'Fredoka', sans-serif;
            background-image: radial-gradient(circle at 2px 2px, rgba(0,0,0,0.1) 2px, transparent 0);
            background-size: 24px 24px;
            color: var(--black);
            padding: 15px;
        }

        .bungee { font-family: 'Bungee', cursive; }

        .retro-card {
            background: white;
            border: 5px solid var(--black);
            box-shadow: 10px 10px 0px var(--black);
            border-radius: 40px;
            overflow: hidden;
        }

        .btn-retro {
            border: 4px solid var(--black);
            border-radius: 999px;
            box-shadow: 5px 5px 0px var(--black);
            font-weight: 800;
            text-transform: uppercase;
            transition: all 0.1s;
            cursor: pointer;
            padding: 10px 20px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn-retro:active {
            transform: translate(3px, 3px);
            box-shadow: 0px 0px 0px var(--black);
        }

        .input-retro {
            border: 3px solid var(--black);
            border-radius: 20px;
            padding: 10px 15px;
            background: var(--bg-cream);
            font-weight: bold;
            outline: none;
            width: 100%;
            font-size: 0.9rem;
        }

        .input-retro:focus {
            background: white;
            border-color: var(--hot-pink);
        }

        #aiToast {
            display: none;
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            animation: slideDown 0.5s forwards;
        }

        @keyframes slideDown {
            from { top: -100px; }
            to { top: 20px; }
        }

        .scroll-hide::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="min-h-screen">

    <div id="aiToast" class="retro-card p-4 bg-white min-w-[300px] flex items-center gap-4 border-4">
        <span class="text-3xl">âœ¨</span>
        <div>
            <p class="text-[10px] font-black text-pink-500 bungee">AI PRAISE</p>
            <p id="aiMsg" class="font-bold text-sm italic"></p>
        </div>
    </div>

    <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <div class="text-center py-6">
            <h1 class="text-5xl md:text-7xl bungee text-white italic" style="-webkit-text-stroke: 3px var(--black); text-shadow: 8px 8px 0px var(--hot-pink);">
                FIT-POP!
            </h1>
            <p class="mt-2 bg-[#FFD93D] inline-block px-6 py-2 border-4 border-black rounded-full font-black text-sm shadow-md rotate-1">
                ä½ çš„åœ“æ»‘å¾©å¤å¥åº·æ´¾å° ğŸ­
            </p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            
            <!-- èº«é«”å¯†ç¢¼ - ç·Šæ¹Šæ’ç‰ˆ -->
            <section class="retro-card p-6 bg-[#FFD93D]">
                <h2 class="text-2xl bungee mb-4 flex items-center gap-2">ğŸ“ èº«é«”å¯†ç¢¼</h2>
                
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <div class="col-span-1">
                        <label class="text-[10px] font-black ml-2 uppercase">Height (cm)</label>
                        <input type="number" id="calc_h" placeholder="èº«é«˜" class="input-retro">
                    </div>
                    <div class="col-span-1">
                        <label class="text-[10px] font-black ml-2 uppercase">Weight (kg)</label>
                        <input type="number" id="calc_w" placeholder="é«”é‡" class="input-retro">
                    </div>
                    <div class="col-span-1">
                        <label class="text-[10px] font-black ml-2 uppercase">Age</label>
                        <input type="number" id="calc_a" placeholder="å¹´é½¡" class="input-retro">
                    </div>
                    <div class="col-span-1">
                        <label class="text-[10px] font-black ml-2 uppercase">Gender</label>
                        <select id="calc_g" class="input-retro">
                            <option value="male">å¸¥å“¥</option>
                            <option value="female">ç¾å¥³</option>
                        </select>
                    </div>
                </div>
                
                <div class="mb-4">
                    <label class="text-[10px] font-black ml-2 uppercase">Activity Level</label>
                    <select id="calc_act" class="input-retro">
                        <option value="1.2">ä¹…åä¸é‹å‹• (1.2)</option>
                        <option value="1.375">è¼•é‡é‹å‹• (1.375)</option>
                        <option value="1.55">ä¸­é‡é‹å‹• (1.55)</option>
                        <option value="1.725">é‡é‡é‹å‹• (1.725)</option>
                    </select>
                </div>

                <button id="btn_calc" class="btn-retro w-full bg-white text-lg py-2">è¨ˆç®—ï¼</button>

                <!-- çµæœå€åŸŸï¼šæ›´æ‰å¹³ç·Šæ¹Š -->
                <div id="tdee_res" class="mt-4 hidden p-4 bg-white border-4 border-black rounded-[25px] flex items-center justify-around">
                    <div class="text-center border-r-2 border-black pr-4">
                        <p class="font-black text-gray-400 text-[9px] bungee">TDEE</p>
                        <h3 id="val_tdee" class="text-2xl font-black text-[#7971EA]">0</h3>
                    </div>
                    <div class="text-center pl-4">
                        <p class="font-black text-pink-500 text-[9px] bungee">DEFICIT (-500)</p>
                        <h4 id="val_deficit" class="text-2xl font-black text-[#FF499E]">0</h4>
                    </div>
                </div>
            </section>

            <!-- é£²é£Ÿç´€éŒ„å™¨ -->
            <section class="retro-card p-6 bg-white">
                <h2 class="text-2xl bungee mb-4 flex items-center gap-2">ğŸ” è²ªåƒç´€éŒ„</h2>
                <div class="space-y-3 mb-4">
                    <input type="text" id="food_name" placeholder="åƒäº†ä»€éº¼ï¼Ÿ" class="input-retro">
                    <div class="flex gap-2">
                        <input type="number" id="food_cal" placeholder="ç†±é‡ (kcal)" class="input-retro">
                        <button id="btn_add_food" class="btn-retro bg-[#7971EA] text-white py-1">ADD</button>
                    </div>
                </div>

                <div id="food_list" class="max-h-40 overflow-y-auto scroll-hide space-y-2 py-2">
                    <p class="text-center text-gray-400 text-sm italic">ä»Šå¤©åƒé»ä»€éº¼ï¼Ÿ</p>
                </div>

                <div class="mt-4 pt-4 border-t-4 border-dotted border-pink-100 flex justify-between items-end">
                    <div>
                        <p class="font-black text-gray-400 text-[10px]">TOTAL</p>
                        <h3 id="total_cal" class="text-3xl font-black">0</h3>
                    </div>
                    <div id="status_tag" class="px-4 py-1 rounded-full border-2 border-black font-black bg-gray-100 rotate-2 text-xs">
                        æœªè¨­ç›®æ¨™
                    </div>
                </div>
            </section>

            <!-- é«”é‡æ›²ç·šåœ– -->
            <section class="retro-card p-6 bg-[#FFF9DE] md:col-span-2">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <div>
                        <h2 class="text-3xl bungee text-[#FF499E]">é«”é‡è¶¨å‹¢</h2>
                        <p class="font-bold text-xs opacity-60">æ¯ç˜¦ 2kg å°±æœ‰æ˜Ÿæ˜Ÿï¼â­</p>
                    </div>
                    <div class="flex gap-2 bg-white p-2 border-2 border-black rounded-full shadow-sm">
                        <input type="number" id="weight_input" step="0.1" placeholder="ä»Šæ—¥é«”é‡" class="outline-none font-black text-lg w-24 px-2 text-center bg-transparent">
                        <button id="btn_save_weight" class="btn-retro bg-[#FFD93D] py-1 text-sm">ç´€éŒ„</button>
                    </div>
                </div>
                <div class="w-full h-64 md:h-80">
                    <canvas id="weight_chart"></canvas>
                </div>
            </section>

            <!-- æ­·å²æ—¥æ›† -->
            <section class="retro-card p-6 bg-white md:col-span-2">
                <h2 class="text-2xl bungee mb-4 text-center">HISTORY</h2>
                <div id="calendar" class="grid grid-cols-7 gap-2">
                    <!-- JS ç”Ÿæˆ -->
                </div>
                <div id="day_detail" class="mt-4 p-4 border-4 border-dashed border-[#FF499E] rounded-[30px] hidden bg-pink-50">
                    <h4 id="detail_date" class="text-xl font-black text-[#FF499E] mb-1"></h4>
                    <p id="detail_info" class="font-bold text-sm"></p>
                </div>
            </section>
        </div>

        <footer class="text-center py-6 bungee text-white text-[10px] opacity-60">
            &copy; 2024 RETRO FIT CLUB.
        </footer>
    </div>

    <script>
        let state = {
            profile: JSON.parse(localStorage.getItem('fpop_profile')) || { tdee: 0 },
            logs: JSON.parse(localStorage.getItem('fpop_logs')) || {},
            weights: JSON.parse(localStorage.getItem('fpop_weights')) || []
        };

        const apiKey = "";
        let chartInstance = null;

        document.addEventListener('DOMContentLoaded', () => {
            initChart();
            renderCalendar();
            updateDietUI();
            
            if(state.profile.tdee) {
                showTDEEResults(state.profile.tdee);
            }

            document.getElementById('btn_save_weight').addEventListener('click', saveWeight);
            document.getElementById('btn_calc').addEventListener('click', calculateTDEE);
            document.getElementById('btn_add_food').addEventListener('click', addFood);
        });

        async function saveWeight() {
            const input = document.getElementById('weight_input');
            const weightVal = parseFloat(input.value);
            if (isNaN(weightVal) || weightVal <= 0) return;

            const today = new Date().toISOString().split('T')[0];
            const existingIndex = state.weights.findIndex(w => w.date === today);

            if (existingIndex > -1) state.weights[existingIndex].weight = weightVal;
            else state.weights.push({ date: today, weight: weightVal });

            state.weights.sort((a, b) => new Date(a.date) - new Date(b.date));
            localStorage.setItem('fpop_weights', JSON.stringify(state.weights));
            updateChart();
            input.value = '';
            await showAiPraise(weightVal);
        }

        async function showAiPraise(w) {
            const toast = document.getElementById('aiToast');
            const msgEl = document.getElementById('aiMsg');
            let message = "ç´€éŒ„æˆåŠŸï¼ä»Šå¤©å¤ªæ£’äº†ï¼âœ¨";
            try {
                const prompt = `ä½¿ç”¨è€…ç´€éŒ„é«”é‡ ${w}kgã€‚è«‹ç”¨å¯æ„›ç¾å¼å¾©å¤é¢¨é¼“å‹µä»–ã€‚ç¹é«”ä¸­æ–‡ï¼Œ15å­—å…§ã€‚`;
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await res.json();
                message = data.candidates?.[0]?.content?.parts?.[0]?.text || message;
            } catch (e) {}
            msgEl.innerText = message;
            toast.style.display = 'flex';
            setTimeout(() => { toast.style.display = 'none'; }, 3000);
        }

        function calculateTDEE() {
            const h = parseFloat(document.getElementById('calc_h').value);
            const w = parseFloat(document.getElementById('calc_w').value);
            const a = parseFloat(document.getElementById('calc_a').value);
            const g = document.getElementById('calc_g').value;
            const act = parseFloat(document.getElementById('calc_act').value);

            if(!h || !w || !a) return;

            let bmr = (10 * w) + (6.25 * h) - (5 * a);
            bmr = (g === 'male') ? bmr + 5 : bmr - 161;
            const tdee = Math.round(bmr * act);

            state.profile = { tdee };
            localStorage.setItem('fpop_profile', JSON.stringify(state.profile));
            showTDEEResults(tdee);
            updateDietUI();
        }

        function showTDEEResults(tdee) {
            document.getElementById('val_tdee').innerText = tdee;
            document.getElementById('val_deficit').innerText = tdee - 500;
            document.getElementById('tdee_res').classList.remove('hidden');
        }

        function addFood() {
            const name = document.getElementById('food_name').value;
            const cal = parseInt(document.getElementById('food_cal').value);
            if(!name || isNaN(cal)) return;

            const today = new Date().toISOString().split('T')[0];
            if(!state.logs[today]) state.logs[today] = { foods: [] };
            state.logs[today].foods.push({ name, cal });

            localStorage.setItem('fpop_logs', JSON.stringify(state.logs));
            updateDietUI();
            document.getElementById('food_name').value = '';
            document.getElementById('food_cal').value = '';
        }

        function updateDietUI() {
            const today = new Date().toISOString().split('T')[0];
            const list = document.getElementById('food_list');
            const log = state.logs[today];
            list.innerHTML = '';
            let total = 0;

            if(log && log.foods.length > 0) {
                log.foods.forEach(f => {
                    total += f.cal;
                    const div = document.createElement('div');
                    div.className = "flex justify-between items-center bg-pink-50 p-3 border-2 border-black rounded-xl font-bold text-xs";
                    div.innerHTML = `<span>${f.name}</span><span class="bg-black text-white px-2 py-0.5 rounded-full">${f.cal}</span>`;
                    list.appendChild(div);
                });
            } else {
                list.innerHTML = `<p class="text-center text-gray-400 text-xs italic">é‚„æ²’ç´€éŒ„ç¾é£Ÿå–”ï¼</p>`;
            }

            document.getElementById('total_cal').innerText = total;
            const tag = document.getElementById('status_tag');
            if(state.profile.tdee) {
                const target = state.profile.tdee - 500;
                if(total > state.profile.tdee) {
                    tag.innerText = "ğŸš¨ çˆ†äº†";
                    tag.className = "px-3 py-1 rounded-full border-2 border-black font-black bg-[#FF499E] text-white rotate-2 text-[10px]";
                } else if (total >= target) {
                    tag.innerText = "ğŸ‘Œ ç¶­æŒ";
                    tag.className = "px-3 py-1 rounded-full border-2 border-black font-black bg-[#FFD93D] rotate-[-2deg] text-[10px]";
                } else {
                    tag.innerText = "ğŸ’ èµ¤å­—";
                    tag.className = "px-3 py-1 rounded-full border-2 border-black font-black bg-[#BAFFB4] rotate-1 text-[10px]";
                }
            }
            renderCalendar();
        }

        function initChart() {
            const ctx = document.getElementById('weight_chart').getContext('2d');
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: state.weights.map(w => w.date),
                    datasets: [{
                        label: 'Weight',
                        data: state.weights.map(w => w.weight),
                        borderColor: '#222',
                        borderWidth: 6,
                        pointRadius: 8,
                        pointBackgroundColor: (ctx) => {
                            const i = ctx.dataIndex;
                            if (i === 0 || !state.weights[0]) return '#7971EA';
                            const initial = state.weights[0].weight;
                            const current = state.weights[i].weight;
                            const prev = state.weights[i-1] ? state.weights[i-1].weight : initial;
                            if(initial - current >= 2 && Math.floor((initial-current)/2) > Math.floor((initial-prev)/2)) return '#FFD93D';
                            return '#FF499E';
                        },
                        pointStyle: (ctx) => {
                            const i = ctx.dataIndex;
                            if (i === 0 || !state.weights[0]) return 'circle';
                            const initial = state.weights[0].weight;
                            const current = state.weights[i].weight;
                            const prev = state.weights[i-1] ? state.weights[i-1].weight : initial;
                            if(initial - current >= 2 && Math.floor((initial-current)/2) > Math.floor((initial-prev)/2)) return 'star';
                            return 'circle';
                        },
                        tension: 0.3,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { display: false }, border: { color: '#000', width: 3 } },
                        y: { grid: { color: '#F0F0F0' }, border: { color: '#000', width: 3 } }
                    }
                }
            });
        }

        function updateChart() {
            if(!chartInstance) return;
            chartInstance.data.labels = state.weights.map(w => w.date);
            chartInstance.data.datasets[0].data = state.weights.map(w => w.weight);
            chartInstance.update();
        }

        function renderCalendar() {
            const grid = document.getElementById('calendar');
            grid.innerHTML = '';
            const now = new Date();
            const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
            const startDay = new Date(now.getFullYear(), now.getMonth(), 1).getDay();

            for(let i=0; i<startDay; i++) grid.appendChild(document.createElement('div'));

            for(let i=1; i<=daysInMonth; i++) {
                const day = document.createElement('div');
                const dStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                const hasData = state.logs[dStr];
                day.innerText = i;
                day.className = `h-10 text-xs flex items-center justify-center rounded-2xl border-2 border-black font-black cursor-pointer shadow-[3px_3px_0px_black] transition-all hover:scale-105 ${hasData ? 'bg-[#7971EA] text-white' : 'bg-white'}`;
                day.onclick = () => {
                    const detail = document.getElementById('day_detail');
                    document.getElementById('detail_date').innerText = dStr;
                    if(hasData) {
                        const total = hasData.foods.reduce((a,b)=>a+b.cal, 0);
                        document.getElementById('detail_info').innerHTML = hasData.foods.map(f => `ğŸ ${f.name} (${f.cal})`).join(', ') + `<br><b>TOTAL: ${total} kcal</b>`;
                    } else {
                        document.getElementById('detail_info').innerText = "é€™å¤©æ²’æœ‰ç´€éŒ„å”· ğŸ˜œ";
                    }
                    detail.classList.remove('hidden');
                };
                grid.appendChild(day);
            }
        }
    </script>
</body>
</html>

