<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bubble Retro Fit v2</title>
    <link href="https://fonts.googleapis.com/css2?family=Bungee&family=Fredoka+One&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --hot-pink: #FF499E;
            --electric-purple: #7971EA;
            --sunny-yellow: #FFD93D;
            --soft-cream: #FFF9DE;
            --ink-black: #222222;
        }

        body {
            background-color: #A095EE;
            font-family: 'Fredoka One', cursive;
            background-image: radial-gradient(circle at 2px 2px, rgba(255,255,255,0.2) 2px, transparent 0);
            background-size: 32px 32px;
            color: var(--ink-black);
            padding-bottom: 50px;
        }

        .bubble-card {
            background: white;
            border: 4px solid var(--ink-black);
            box-shadow: 10px 10px 0px var(--ink-black);
            border-radius: 40px;
            transition: all 0.2s ease;
        }

        .bungee { font-family: 'Bungee', cursive; }

        .btn-main {
            border: 4px solid var(--ink-black);
            border-radius: 9999px;
            box-shadow: 6px 6px 0px var(--ink-black);
            transition: all 0.1s;
            font-weight: 900;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn-main:active {
            transform: translate(4px, 4px);
            box-shadow: 0px 0px 0px var(--ink-black);
        }

        .input-bubble {
            border: 4px solid var(--ink-black);
            border-radius: 25px;
            padding: 12px 20px;
            background: var(--soft-cream);
            font-weight: bold;
            outline: none;
        }

        .input-bubble:focus {
            background: white;
            border-color: var(--hot-pink);
        }

        #aiLoader {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            z-index: 100;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid var(--soft-cream);
            border-top: 5px solid var(--hot-pink);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="p-4">

    <div id="aiLoader">
        <div class="spinner"></div>
        <p class="text-white mt-4 bungee">AI æ­£åœ¨ç‚ºä½ åŠ æ²¹...</p>
    </div>

    <div class="max-w-5xl mx-auto">
        <!-- Title -->
        <header class="text-center py-10">
            <h1 class="text-6xl md:text-8xl bungee text-white italic" style="-webkit-text-stroke: 3px var(--ink-black); text-shadow: 8px 8px 0px var(--hot-pink);">
                RETRO-GO!
            </h1>
            <div class="mt-4 bg-[#FFD93D] inline-block px-8 py-2 border-4 border-black rounded-full rotate-2 shadow-lg font-black text-xl">
                åœ“æ»‘ç¾å¼å¾©å¤æ´¾å° ğŸ©
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <!-- TDEE Calculator -->
            <div class="lg:col-span-5 bubble-card p-8 bg-[#FFD93D]">
                <h2 class="text-3xl bungee mb-6">ğŸ“ è¨ˆç®— TDEE</h2>
                <div class="flex flex-col gap-4">
                    <div class="flex gap-2">
                        <input type="number" id="h" placeholder="èº«é«˜" class="input-bubble w-1/2">
                        <input type="number" id="w" placeholder="é«”é‡" class="input-bubble w-1/2">
                    </div>
                    <div class="flex gap-2">
                        <input type="number" id="a" placeholder="å¹´é½¡" class="input-bubble w-1/2">
                        <select id="g" class="input-bubble w-1/2">
                            <option value="male">å¸¥å“¥</option>
                            <option value="female">ç¾å¥³</option>
                        </select>
                    </div>
                    <select id="act" class="input-bubble w-full">
                        <option value="1.2">ä¹…åä¸é‹å‹•</option>
                        <option value="1.375">è¼•é‡ (1-3å¤©/é€±)</option>
                        <option value="1.55">ä¸­é‡ (3-5å¤©/é€±)</option>
                        <option value="1.725">é‡é‡ (6-7å¤©/é€±)</option>
                    </select>
                    <button onclick="doCalc()" class="btn-main py-4 bg-[#FF499E] text-white text-xl">é–‹å§‹è¨ˆç®—ï¼</button>
                </div>
                <div id="resBox" class="mt-8 hidden p-6 bg-white border-4 border-black rounded-[30px] text-center">
                    <p class="font-black text-gray-400">DAILY TDEE</p>
                    <h3 id="tVal" class="text-5xl font-black text-[#7971EA]">--</h3>
                    <div class="mt-4 bg-[#FF499E] p-4 rounded-2xl text-white border-2 border-black">
                        <p class="font-bold">æ¸›è„‚èµ¤å­—ç›®æ¨™ (-500)</p>
                        <h4 id="dVal" class="text-3xl font-black">--</h4>
                    </div>
                </div>
            </div>

            <!-- Diet Tracker -->
            <div class="lg:col-span-7 bubble-card p-8 bg-white">
                <h2 class="text-3xl bungee mb-6">ğŸ” é£²é£Ÿå¸³æœ¬</h2>
                <div class="flex flex-col md:flex-row gap-2 mb-6">
                    <input type="text" id="fName" placeholder="åƒäº†ä»€éº¼ï¼Ÿ" class="input-bubble flex-grow">
                    <input type="number" id="fCal" placeholder="ç†±é‡" class="input-bubble md:w-28">
                    <button onclick="addFood()" class="btn-main px-6 py-3 bg-[#7971EA] text-white">ADD</button>
                </div>
                <div id="foodList" class="space-y-2 max-h-60 overflow-y-auto pr-2 italic text-gray-400 text-center py-4">
                    ä»Šå¤©é‚„æ²’åƒæ±è¥¿å”·...
                </div>
                <div class="mt-6 pt-6 border-t-4 border-dotted border-gray-200 flex justify-between items-end">
                    <div>
                        <p class="font-black text-gray-400 text-xs">TOTAL</p>
                        <h3 id="totalDisplay" class="text-4xl font-black">0</h3>
                    </div>
                    <div id="statusBadge" class="px-4 py-2 rounded-full border-4 border-black font-black bg-gray-100 rotate-2">
                        å°šæœªè¨­å®šç›®æ¨™
                    </div>
                </div>
            </div>

            <!-- Weight Chart -->
            <div class="lg:col-span-12 bubble-card p-8 bg-[#FFF9DE]">
                <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                    <div>
                        <h2 class="text-4xl bungee text-[#FF499E]">é«”é‡è®ŠåŒ–ç´€éŒ„</h2>
                        <p class="font-bold opacity-60">æ¯æ¸› 2kg å°±æœƒå‡ºç¾çå‹µæ˜Ÿæ˜Ÿï¼â­</p>
                    </div>
                    <div class="flex gap-2">
                        <input type="number" id="wInput" step="0.1" placeholder="è¼¸å…¥é«”é‡" class="input-bubble w-32">
                        <button onclick="recordWeight()" class="btn-main px-8 py-3 bg-white">ç´€éŒ„é«”é‡</button>
                    </div>
                </div>
                <div id="aiBox" class="hidden mb-6 p-6 bg-white border-4 border-black rounded-[30px] items-center gap-4">
                    <span class="text-4xl">ğŸ</span>
                    <p id="aiMsg" class="text-xl font-black italic text-[#7971EA]"></p>
                </div>
                <div class="w-full h-80">
                    <canvas id="wChart"></canvas>
                </div>
            </div>

            <!-- Calendar -->
            <div class="lg:col-span-12 bubble-card p-8 bg-white">
                <h2 class="text-3xl bungee mb-6 text-center italic">HISTORY CALENDAR</h2>
                <div id="calGrid" class="grid grid-cols-7 gap-3 text-center">
                    <!-- JS Injected -->
                </div>
                <div id="dayInfo" class="mt-6 p-6 border-4 border-dashed border-[#A095EE] rounded-[30px] hidden">
                    <h4 id="infoDate" class="text-2xl font-black text-[#7971EA]"></h4>
                    <p id="infoContent" class="mt-2 font-bold"></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const apiKey = "";
        let appData = {
            profile: JSON.parse(localStorage.getItem('ret_profile')) || { tdee: 0 },
            logs: JSON.parse(localStorage.getItem('ret_logs')) || {},
            weights: JSON.parse(localStorage.getItem('ret_weights')) || []
        };

        let myChart;

        window.onload = () => {
            initChart();
            renderCalendar();
            refreshDietUI();
            if(appData.profile.tdee) {
                document.getElementById('resBox').classList.remove('hidden');
                document.getElementById('tVal').innerText = appData.profile.tdee;
                document.getElementById('dVal').innerText = appData.profile.tdee - 500;
            }
        };

        function doCalc() {
            const h = parseFloat(document.getElementById('h').value);
            const w = parseFloat(document.getElementById('w').value);
            const a = parseFloat(document.getElementById('a').value);
            if(!h || !w || !a) return alert("è«‹è¼¸å…¥å®Œæ•´æ•¸æ“šå”·ï¼");

            let bmr = (10 * w) + (6.25 * h) - (5 * a);
            bmr = (document.getElementById('g').value === 'male') ? bmr + 5 : bmr - 161;
            const tdee = Math.round(bmr * parseFloat(document.getElementById('act').value));
            
            appData.profile = { tdee };
            localStorage.setItem('ret_profile', JSON.stringify(appData.profile));
            
            document.getElementById('tVal').innerText = tdee;
            document.getElementById('dVal').innerText = tdee - 500;
            document.getElementById('resBox').classList.remove('hidden');
            refreshDietUI();
        }

        function addFood() {
            const name = document.getElementById('fName').value;
            const cal = parseInt(document.getElementById('fCal').value);
            if(!name || isNaN(cal)) return;

            const today = new Date().toISOString().split('T')[0];
            if(!appData.logs[today]) appData.logs[today] = { foods: [] };
            appData.logs[today].foods.push({ name, cal });
            
            save();
            refreshDietUI();
            document.getElementById('fName').value = '';
            document.getElementById('fCal').value = '';
        }

        function refreshDietUI() {
            const today = new Date().toISOString().split('T')[0];
            const list = document.getElementById('foodList');
            const log = appData.logs[today];
            list.innerHTML = '';
            let total = 0;

            if(log && log.foods.length > 0) {
                log.foods.forEach(f => {
                    total += f.cal;
                    const item = document.createElement('div');
                    item.className = "flex justify-between items-center bg-[#FFF9DE] p-3 border-2 border-black rounded-2xl mb-2 font-black italic";
                    item.innerHTML = `<span>${f.name}</span><span class="bg-black text-white px-3 py-1 rounded-full text-xs">${f.cal} kcal</span>`;
                    list.appendChild(item);
                });
            } else {
                list.innerHTML = "ä»Šå¤©é‚„æ²’åƒæ±è¥¿å”·...";
            }

            document.getElementById('totalDisplay').innerText = total;
            const badge = document.getElementById('statusBadge');
            if(appData.profile.tdee) {
                const target = appData.profile.tdee - 500;
                if(total > appData.profile.tdee) {
                    badge.innerText = "ğŸš¨ çˆ†ç†±é‡äº†ï¼";
                    badge.className = "px-4 py-2 rounded-full border-4 border-black font-black bg-[#FF499E] text-white rotate-2";
                } else if (total >= target) {
                    badge.innerText = "ğŸ‘Œ ç¶­æŒä¸­";
                    badge.className = "px-4 py-2 rounded-full border-4 border-black font-black bg-[#FFD93D] rotate-[-2deg]";
                } else {
                    badge.innerText = "ğŸ’ å®Œç¾èµ¤å­—";
                    badge.className = "px-4 py-2 rounded-full border-4 border-black font-black bg-[#BAFFB4] rotate-1";
                }
            }
            renderCalendar();
        }

        async function recordWeight() {
            const val = parseFloat(document.getElementById('wInput').value);
            if(isNaN(val)) return alert("è«‹è¼¸å…¥æ­£ç¢ºé«”é‡æ•¸å­—ï¼");

            const today = new Date().toISOString().split('T')[0];
            const idx = appData.weights.findIndex(x => x.date === today);
            
            if(idx > -1) appData.weights[idx].weight = val;
            else appData.weights.push({ date: today, weight: val });
            
            appData.weights.sort((a,b) => new Date(a.date) - new Date(b.date));
            save();
            updateChart();
            document.getElementById('wInput').value = '';

            // AI 
            const loader = document.getElementById('aiLoader');
            loader.style.display = 'flex';
            try {
                const prompt = `ä½¿ç”¨è€…é«”é‡ç´€éŒ„ç‚º ${val}kgã€‚è«‹ç”¨ä¸€å¥è¶…ç´šå¯æ„›ã€ç¾å¼å¾©å¤é¢¨ã€æ´»æ½‘åœ“æ»‘çš„èªæ°£é¼“å‹µä»–ã€‚ç¹é«”ä¸­æ–‡ï¼Œ20å­—å…§ã€‚`;
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await res.json();
                const msg = data.candidates?.[0]?.content?.parts?.[0]?.text || "ä½ æ˜¯æœ€æ£’çš„å°ç”œå¿ƒï¼åŠ æ²¹ï¼";
                document.getElementById('aiBox').style.display = 'flex';
                document.getElementById('aiMsg').innerText = msg;
            } catch(e) {
                document.getElementById('aiBox').style.display = 'flex';
                document.getElementById('aiMsg').innerText = "å¤ªæ£’äº†ï¼ç´€éŒ„æˆåŠŸï¼ä½ æ˜¯é–ƒäº®ä¹‹æ˜Ÿï¼";
            }
            loader.style.display = 'none';
        }

        function initChart() {
            const ctx = document.getElementById('wChart').getContext('2d');
            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: appData.weights.map(w => w.date),
                    datasets: [{
                        label: 'é«”é‡',
                        data: appData.weights.map(w => w.weight),
                        borderColor: '#222',
                        borderWidth: 6,
                        pointRadius: 10,
                        pointBackgroundColor: (ctx) => {
                            const i = ctx.dataIndex;
                            if(i === 0) return '#7971EA';
                            const start = appData.weights[0].weight;
                            const cur = appData.weights[i].weight;
                            const prev = appData.weights[i-1] ? appData.weights[i-1].weight : start;
                            if(start - cur >= 2 && Math.floor((start-cur)/2) > Math.floor((start-prev)/2)) return '#FFD93D';
                            return '#FF499E';
                        },
                        pointStyle: (ctx) => {
                            const i = ctx.dataIndex;
                            if(i === 0) return 'circle';
                            const start = appData.weights[0].weight;
                            const cur = appData.weights[i].weight;
                            const prev = appData.weights[i-1] ? appData.weights[i-1].weight : start;
                            if(start - cur >= 2 && Math.floor((start-cur)/2) > Math.floor((start-prev)/2)) return 'star';
                            return 'circle';
                        },
                        tension: 0.4,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { grid: { display: false }, border: { width: 4, color: '#000' } },
                        x: { grid: { display: false }, border: { width: 4, color: '#000' } }
                    }
                }
            });
        }

        function updateChart() {
            myChart.data.labels = appData.weights.map(w => w.date);
            myChart.data.datasets[0].data = appData.weights.map(w => w.weight);
            myChart.update();
        }

        function renderCalendar() {
            const grid = document.getElementById('calGrid');
            grid.innerHTML = '';
            const now = new Date();
            const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
            const firstDay = new Date(now.getFullYear(), now.getMonth(), 1).getDay();

            for(let i=0; i<firstDay; i++) grid.appendChild(document.createElement('div'));

            for(let i=1; i<=daysInMonth; i++) {
                const day = document.createElement('div');
                const dStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                const hasData = appData.logs[dStr];
                day.innerText = i;
                day.className = `h-12 flex items-center justify-center rounded-2xl border-2 border-black font-black cursor-pointer shadow-[4px_4px_0px_black] ${hasData ? 'bg-[#7971EA] text-white' : 'bg-white'}`;
                day.onclick = () => {
                    const info = document.getElementById('dayInfo');
                    document.getElementById('infoDate').innerText = dStr;
                    if(hasData) {
                        const total = hasData.foods.reduce((a,b)=>a+b.cal, 0);
                        document.getElementById('infoContent').innerHTML = hasData.foods.map(f => `ğŸ¬ ${f.name} (${f.cal}kcal)`).join('<br>') + `<br><br>ç¸½è¨ˆ: ${total} kcal`;
                    } else {
                        document.getElementById('infoContent').innerText = "é€™å¤©æ²’æœ‰ç´€éŒ„å”·ï¼";
                    }
                    info.classList.remove('hidden');
                };
                grid.appendChild(day);
            }
        }

        function save() {
            localStorage.setItem('ret_logs', JSON.stringify(appData.logs));
            localStorage.setItem('ret_weights', JSON.stringify(appData.weights));
        }
    </script>
</body>
</html>

